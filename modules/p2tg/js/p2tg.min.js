!function(i,c,r){"use strict";var s={configure:function(){s.page=i("#cmb2-metabox-wptelegram_p2tg"),s.channels=s.page.find("#channels"),s.post_types=s.page.find('input[type="checkbox"][name="post_types[]"]')},init:function(){s.configure(),s.page.on("blur","#channels",s.handle_blur),s.page.on("click","#test-channels",s.send_test_message),s.page.on("change",s.post_types,s.toggle_rules),s.page.on("change","#single_message",s.validate_single_message),s.page.on("change",'input[type="radio"][name="parse_mode"],#misc1',function(){s.page.find("#single_message").trigger("change")}),s.page.on("change",".p2tg-rules .param select",s.update_select_value),s.page.on("click",".p2tg-rules-add",s.add_rule),s.page.on("click",".p2tg-rules-remove",s.remove_rule),s.page.on("click",".p2tg-rules-add-group",s.add_group),s.page.find(".p2tg-rules .param select").trigger("change")},handle_blur:function(){var e=s.channels.val().trim().replace(/[\s]/g,"");if(e){s.channels.val(e),e=e.split(",");var t=s.page.find("#p2tg-chat-list");s.page.find("#p2tg-mem-count").removeClass("hidden"),t.text("");for(var a=0;a<e.length;a++)""!=e[a]&&r.getChatMembersCount({chat_id:e[a]},s.handle_chat_member_count,t)}},handle_chat_member_count:function(e,t,a){var r,n,s=i("<li/>").append(i("<span/>",{text:t.chat_id+": "})),l=i("<span/>",{class:"wptelegram-info"});void 0===e||""==e.responseText?(l.addClass("error"),n=c.error+" "+c.could_not_connect):200==e.status&&1==JSON.parse(e.responseText).ok?(n=JSON.parse(e.responseText).result,l.addClass("info")):(r=JSON.parse(e.responseText),l.addClass("error"),n=c.error+" "+r.error_code+" - "+r.description),a.append(s.append(l.text(n)))},send_test_message:function(e){var t=i(this),a=s.channels.val().trim().replace(/[\s]/g,""),r=s.page.find("#p2tg-chat-table");a?(wptelegram.set_event(e).lock_button(t),wptelegram.utils.send_test_message(a,r)):window.alert(c.empty_channels)},toggle_rules:function(){var e=s.page.find(".cmb2-id-wptg_p2tg-rules,.cmb2-id-wptg_p2tg-and");s.post_types.filter(":checked").length?e.show():e.hide()},validate_single_message:function(){var e=i(this),t=e.closest(".cmb-td").find(".should-be").css({color:"inherit"});if(e.is(":checked")){var a=!0,r=s.page.find('input[type="radio"][name="parse_mode"]:checked').val(),n=s.page.find("#misc1").is(":checked");"none"==r&&(t.filter('[data-id="parse_mode"]').css({color:"red"}),a=!1),n&&(t.filter('[data-id="misc1"]').css({color:"red"}),a=!1),a||e.prop("checked",!1)}},update_select_value:function(){var e=i(this),t=e.closest("tr");if(e.val()){var a=t.attr("data-id"),r=t.closest(".p2tg-rules-group").attr("data-id"),n=t.find("td.values"),s={action:"wptg_p2tg_rule_values",nonce:wptelegram.ajax.nonce,rule_id:a,group_id:r,values:n.find("select").val(),param:e.val()},l=i('<div class="wptelegram-loading"></div>');n.html(l),i.ajax({url:wptelegram.ajax.url,data:s,type:"post",dataType:"html",success:function(e){l.replaceWith(e),n.find("select").select2({placeholder:c.choose})}})}else t.find("td.values").html(i("<select/>"))},add_rule:function(e){e.preventDefault();var t=i(this).closest("tr"),a=t.clone(),r=a.attr("data-id"),n=wptelegram.utils.uniqid();return a.find("[name]").each(function(){i(this).attr("name",i(this).attr("name").replace(r,n)),i(this).attr("id",i(this).attr("id").replace(r,n))}),a.attr("data-id",n),t.after(a),a.find(".param select").val("").trigger("change"),!1},remove_rule:function(e){e.preventDefault();var t=i(this).closest("tr"),a=t.closest(".p2tg-rules-group");t.siblings("tr").length?t.remove():a.siblings(".p2tg-rules-group").length?a.remove():t.find(".param select").val("").trigger("change")},add_group:function(e){e.preventDefault();var t=i(this).parent().find(".p2tg-rules-group:last"),a=t.clone(),r=a.attr("data-id"),n=wptelegram.utils.uniqid();a.find("[name]").each(function(){i(this).attr("name",i(this).attr("name").replace(r,n)),i(this).attr("id",i(this).attr("id").replace(r,n))}),a.attr("data-id",n),a.find("tr:not(:first)").remove(),t.after(a),a.find("tr .param select").val("").trigger("change")}};i(s.init)}(jQuery,wptelegram.l10n,wptelegram.bot_api);